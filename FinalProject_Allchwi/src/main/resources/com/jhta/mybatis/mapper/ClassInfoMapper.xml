<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jhta.mybatis.mapper.ClassInfoMapper">
	<insert id="insert" parameterType="classInfo">
		insert into class_info values(null,#{ml_num},#{scategory_num},#{sloc_num},#{pro_num},
		#{tutor_nickname},#{tutor_phone},#{class_address},#{class_form},#{class_max},#{class_min},
		#{class_title},#{class_price},#{class_hour},#{class_count},#{tutor_about},#{class_about},#{class_target},now(),#{class_auth})
		<selectKey keyProperty="class_num" resultType="int">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	
	<!-- only small location 검색 sql -->
	<sql id="sloc">
		<if test="sloc_num>0 ">
			and sloc_num=#{sloc_num}
		</if>	
	</sql>
	
	
	<sql id="keyword">
		<if test="keyword!=null and keyword!=''">
			and class_title like '%${keyword}%'
		</if>
	</sql>
	
	<sql id="date">
		<if test="start_Date!=null and start_Date!='' and end_Date!=null and end_Date!=''">
			and class_date between date('${start_Date}') and date('${end_Date}')+1
		</if>
	</sql>
	

	
	
	<!-- keyword & small location 검색 sql -->
	<sql id="key">
	<choose>
		<when test="keyword!=null and keyword!='' and sloc_num==-1">
			<where>
				class_title like '%${keyword}%'
			</where>
		</when>
		<when test="keyword!=null and keyword!='' and sloc_num>0">
			<where>
				class_title like '%${keyword}%' and sloc_num=#{sloc_num}
			</where>
		</when>
	</choose>
	</sql>
	
	
	<!-- keyword 검색 sql -->
	<sql id="keyword_count">
		<if test="keyword!=null and keyword!=''">
			(select class_num 
			from class_info 
			<include refid="key"/>
			) a
		</if>	
	</sql>

	

	
	<!-- category 검색 sql -->
	
	<sql id="smallcategory">
		<choose>
			<when test="scategory_num>0 ">
				and scategory_num=#{scategory_num}
			</when>
		</choose>
	</sql>
	<sql id="bigcategory">
		<if test="bcategory_num>0">
			and b.bcategory_num=#{bcategory_num}
		</if>
	</sql>

		
	
	<select id="keyword_list" parameterType="hashmap" resultType="classinfo">
		select class_num, class_title, tutor_nickname 
		from class_info 
		<include refid="key"/>
		order by class_num desc
		limit #{startRow},6
	</select>
	

	<select id="list" parameterType="hashmap" resultType="classinfo">
		select c.class_num, class_title, tutor_nickname, bcategory_num, bcategory_name,scategory_name, sloc_num
		from 
				(
					select s.bcategory_num, bcategory_name, scategory_num, scategory_name 
					from small_category s, big_category b
					where s.bcategory_num=b.bcategory_num 				
					<include refid="smallcategory"/>								
					<include refid="bigcategory"/>	
				)a, class_info c 
		where a.scategory_num=c.scategory_num 
		<include refid="sloc"/>		
		order by class_num desc
		limit #{startRow},6
	</select>

	<select id="date_list" parameterType="hashmap" resultType="classinfo">
		select c.class_num, class_title, tutor_nickname, bcategory_num, bcategory_name,scategory_name, sloc_num, 
		date_num, class_date, class_startTime, class_endDate 
		from 
				(
					select s.bcategory_num, bcategory_name, scategory_num, scategory_name 
					from small_category s, big_category b
					where s.bcategory_num=b.bcategory_num 				
					<include refid="smallcategory"/>								
					<include refid="bigcategory"/>	
				)a, class_info c , class_date cd
		where a.scategory_num=c.scategory_num and cd.class_num=c.class_num	
		<include refid="sloc"/>		
		<include refid="date"/>
		order by class_num desc
		limit #{startRow},6
	</select>
	
	
	
	
	<sql id="small_count">	
		<choose>
			<when test="scategory_num>0 and sloc_num==-1">
				class_info where scategory_num=#{scategory_num}	
			</when>
			<when test="scategory_num>0 and sloc_num>0">
				class_info where scategory_num=#{scategory_num}	
				and sloc_num=#{sloc_num}
			</when>
				
		</choose>
		
	</sql>
	
	<sql id="big_count">
		<if test="bcategory_num>0">
			(
				select class_num, c.scategory_num from
					(
						select s.bcategory_num, bcategory_name, scategory_num, scategory_name 
						from small_category s, big_category b
						where s.bcategory_num=b.bcategory_num and s.bcategory_num=#{bcategory_num}
					) x , class_info c
			        where x.scategory_num=c.scategory_num
			) a
		</if>
	</sql>
	
	<select id="count" resultType="int" parameterType="hashmap">
		select NVL(count(*),0) from
		    <include refid="small_count"/>
			<include refid="big_count"/>	
			<include refid="keyword_count"/>	
	</select>
	
	<select id="getInfo" parameterType="int" resultType="classinfo">
		select * from class_info where class_num=#{class_num}
	</select> 

</mapper>

